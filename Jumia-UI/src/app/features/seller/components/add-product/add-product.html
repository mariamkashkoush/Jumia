<div class="product-management-container">
  <div class="header">
    <h2>{{ isEditMode ? 'Edit Product' : 'Add New Product' }}</h2>
  </div>

  <div class="form-container">
    <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="product-form">
      <div class="form-section">
        <h4>Select Product Category</h4>

        <div formArrayName="categoryIds" class="category-selects-container">
          <div *ngFor="let categoryControl of categoryIdsArray.controls; let i = index" class="form-group">
            <label *ngIf="i === 0">Main Category</label>
            <label *ngIf="i > 0">Sub-Category Level {{i}}</label>
            <select [formControlName]="i" class="form-control" (change)="onCategorySelect(i)">
              <option value="">Select {{ i === 0 ? 'a Main Category' : 'a Sub-Category' }}</option>
              <option *ngFor="let category of displayedCategoryLevels[i]" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
            <div class="error" *ngIf="categoryControl.invalid && categoryControl.touched">
              {{ i === 0 ? 'Main category' : 'Sub-category' }} is required
            </div>
          </div>
        </div>
      </div>

      <hr>

      <div class="form-section">
        <h4>Product Details</h4>
        <div class="form-row">
          <div class="form-group">
            <label for="name">Product Name</label>
            <input type="text" id="name" formControlName="name" class="form-control">
            <div class="error" *ngIf="productForm.get('name')?.invalid && productForm.get('name')?.touched">
              Product Name is required.
            </div>
          </div>

          <div class="form-group">
            <label for="basePrice">Base Price</label>
            <input type="number" id="basePrice" formControlName="basePrice" class="form-control" min="0">
            <div class="error" *ngIf="productForm.get('basePrice')?.invalid && productForm.get('basePrice')?.touched">
              Base Price is required and must be a non-negative number.
            </div>
          </div>
        </div>
        <div class="form-group" *ngIf="variantsArray.length === 0">
          <label for="productDiscount">Product Discount (%)</label>
          <input type="number" id="productDiscount" formControlName="productDiscount" class="form-control" min="0"
            max="100">
          <div class="error"
            *ngIf="productForm.get('productDiscount')?.invalid && productForm.get('productDiscount')?.touched">
            Discount must be between 0 and 100.
          </div>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" formControlName="description" class="form-control" rows="4"></textarea>
          <div class="error" *ngIf="productForm.get('description')?.invalid && productForm.get('description')?.touched">
            Description is required.
          </div>
        </div>

        <div class="form-group">
          <label for="quantity">Product Quantity</label>
          <input type="number" id="quantity" formControlName="quantity" class="form-control" min="0">
          <div class="error" *ngIf="productForm.get('quantity')?.invalid && productForm.get('quantity')?.touched">
            Product Quantity is required and must be a non-negative number.
          </div>
        </div>
      </div>

      <hr>

      <div class="form-section">
        <h4>Product Images</h4>
        <div class="form-group">
          <label for="mainImage">Main Image</label>
          <input type="file" id="mainImage" (change)="onFileSelect($event, 'mainImageUrl')" class="form-control-file">
          <div class="error"
            *ngIf="productForm.get('mainImageUrl')?.invalid && productForm.get('mainImageUrl')?.touched">
            Main Image is required.
          </div>
          <div *ngIf="productForm.get('mainImageUrl')?.value" class="image-preview">
            <img [src]=" baseImageUrl+ productForm.get('mainImageUrl')?.value" alt="Main Image Preview" class="preview-img">
          </div>
        </div>

        <div class="form-group">
          <label for="additionalImages">Additional Images</label>
          <input type="file" id="additionalImages" multiple (change)="onMultipleFileSelect($event)"
            class="form-control-file">
          <div class="image-preview-multiple">
            <div *ngFor="let imgUrl of productForm.get('additionalImageUrls')?.value" class="preview-item">
              <img [src]="baseImageUrl+ imgUrl" alt="Additional Image Preview" class="preview-img">
            </div>
          </div>
        </div>
      </div>

      <hr>

      <div class="form-section" *ngIf="variantsArray.length === 0">
        <h4>Product Attributes (No Variants)</h4>
        <div *ngIf="availableCategoryAttributes.length === 0 && productForm.get('categoryIds')?.valid">
          <p>No attributes found for the selected category or sub-category. Select a deeper category if available or add
            variants.</p>
        </div>
        <div formArrayName="attributes" *ngIf="attributesArray.length > 0">
          <div *ngFor="let attributeGroup of attributesArray.controls; let i = index" [formGroupName]="i"
            class="attribute-group">
            <label>{{ attributeGroup.get('attributeName')?.value }}</label>
            <ng-container [ngSwitch]="attributeGroup.get('attributeType')?.value">
              <input *ngSwitchCase="'text'" type="text" formControlName="value" class="form-control">
              <input *ngSwitchCase="'number'" type="number" formControlName="value" class="form-control">
              <input *ngSwitchCase="'boolean'" type="checkbox" formControlName="value" class="form-check-input">
              <select *ngSwitchCase="'select'" formControlName="value" class="form-control">
                <option value="">Select a value</option>
                <option *ngFor="let possibleValue of attributeGroup.get('possibleValues')?.value | jsonParse"
                  [value]="possibleValue">
                  {{ possibleValue }}
                </option>
              </select>
              <div class="error" *ngIf="attributeGroup.get('value')?.invalid && attributeGroup.get('value')?.touched">
                Value is required.
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <hr *ngIf="variantsArray.length === 0">

      <div class="form-section">

        <h4>Product Variants</h4>

        <div formArrayName="variants" class="variants-container">
          <div *ngFor="let variantGroup of variantsArray.controls; let i = index" [formGroupName]="i"
            class="variant-card">
            <h5>Variant {{ i + 1 }}</h5>
            <div class="form-row">
              <div class="form-group">
                <label for="variantName{{i}}">Variant Name</label>
                <input type="text" id="variantName{{i}}" formControlName="variantName" class="form-control">
                <div class="error"
                  *ngIf="variantGroup.get('variantName')?.invalid && variantGroup.get('variantName')?.touched">
                  Variant Name is required.
                </div>
              </div>
              <div class="form-group">
                <label for="sku{{i}}">SKU</label>
                <input type="text" id="sku{{i}}" formControlName="sku" class="form-control">
                <div class="error" *ngIf="variantGroup.get('sku')?.invalid && variantGroup.get('sku')?.touched">
                  SKU is required.
                </div>
              </div>
              
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="price{{i}}">Price</label>
                <input type="number" id="price{{i}}" formControlName="price" class="form-control" min="0">
                <div class="error" *ngIf="variantGroup.get('price')?.invalid && variantGroup.get('price')?.touched">
                  Price is required and must be non-negative.
                </div>
              </div>
              <div class="form-group">
                <label for="discountPercentage{{i}}">Discount %</label>
                <input type="number" id="discountPercentage{{i}}" formControlName="discountPercentage"
                  class="form-control" min="0" max="100">
                <div class="error"
                  *ngIf="variantGroup.get('discountPercentage')?.invalid && variantGroup.get('discountPercentage')?.touched">
                  Discount % must be between 0 and 100.
                </div>
              </div>
              <div class="form-group">
                <label for="stockQuantity{{i}}">Stock Quantity</label>
                <input type="number" id="stockQuantity{{i}}" formControlName="stockQuantity" class="form-control"
                  min="0">
                <div class="error"
                  *ngIf="variantGroup.get('stockQuantity')?.invalid && variantGroup.get('stockQuantity')?.touched">
                  Stock Quantity is required and must be non-negative.
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="variantImage{{i}}">Variant Image</label>
              <input type="file" id="variantImage{{i}}" (change)="onFileSelect($event, 'variantImageUrl', i)"
                class="form-control-file">
              <div *ngIf="variantGroup.get('variantImageUrl')?.value" class="image-preview">
                <img [src]="baseImageUrl+ variantGroup.get('variantImageUrl')?.value" alt="Variant Image Preview" class="preview-img">
              </div>
            </div>

            <div class="form-row form-check-row">
              <div class="form-check">
                <input type="checkbox" id="isDefault{{i}}" formControlName="isDefault" class="form-check-input">
                <label class="form-check-label" for="isDefault{{i}}">Is Default Variant</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="isAvailable{{i}}" formControlName="isAvailable" class="form-check-input">
                <label class="form-check-label" for="isAvailable{{i}}">Is Available</label>
              </div>
            </div>

            <hr>

            <h6>Variant Attributes</h6>
            <button type="button" class="btn btn-add-small" (click)="addVariantAttribute(i)">Add Attribute</button>
            <div formArrayName="attributes" class="variant-attributes-container">
              <div *ngFor="let vAttrGroup of getVariantAttributesArray(i).controls; let attrIndex = index"
                [formGroupName]="attrIndex" class="attribute-row">
                <div class="form-group flex-grow">
                  <label>Attribute Type</label>
                  <select formControlName="attributeId" class="form-control"
                    (change)="onVariantAttributeChange(i, attrIndex)">
                    <option value="">Select Attribute</option>
                    <option *ngFor="let catAttr of availableCategoryAttributes" [value]="catAttr.attributeId">
                      {{ catAttr.name }}
                    </option>
                  </select>
                  <div class="error"
                    *ngIf="vAttrGroup.get('attributeId')?.invalid && vAttrGroup.get('attributeId')?.touched">
                    Attribute type is required.
                  </div>
                </div>
                <div class="form-group flex-grow">
                  <label>Attribute Name</label>
                  <input type="text" formControlName="attributeName" class="form-control" readonly>
                </div>
                <div class="form-group flex-grow">
                  <label>Attribute Value</label>
                  <input type="text" formControlName="attributeValue" class="form-control">
                  <div class="error"
                    *ngIf="vAttrGroup.get('attributeValue')?.invalid && vAttrGroup.get('attributeValue')?.touched">
                    Attribute value is required.
                  </div>
                </div>
                <button type="button" class="btn btn-remove-small"
                  (click)="removeVariantAttribute(i, attrIndex)">Remove</button>
              </div>
            </div>

            <button type="button" class="btn btn-remove" (click)="removeVariant(i)">Remove Variant</button>
          </div>
        </div>
        
        <button type="button" class="btn btn-add" (click)="addVariant()">Add Variant</button>
        <div *ngIf="variantsArray.length === 0" class="no-variants-message">
          <p>Add variants if your product comes in different options (e.g., sizes, colors).</p>
        </div>
      </div>

      <hr>

      <div class="form-actions">
        <button type="submit" class="btn btn-primary">{{ isEditMode ? 'Update Product' : 'Add Product' }}</button>
        <button type="button" class="btn btn-secondary" (click)="cancel()">Cancel</button>
      </div>
    </form>
  </div>
</div>