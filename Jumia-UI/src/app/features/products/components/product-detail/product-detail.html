<div *ngIf="product as p; else loading">

  <div class="product-container">
    <div class="product-card">
      <div class="product-images">
        <div class="main-image-container">
          <img [src]="baseImageUrl + allImages[currentImageIndex]" class="main-image" />
        </div>
        <div class="image-thumbnails">
          <div class="thumbnail" *ngFor="let img of allImages; let i = index" [class.active]="i === currentImageIndex"
            (click)="selectImage(i)">
            <img [src]="baseImageUrl + img" />
          </div>
        </div>
        <div class="share-section">
          <h4>Share this product</h4>
          <div>
            <button class="share-btn facebook">&#xf09a;</button>
            <button class="share-btn twitter">&#xf099;</button>
            <button class="share-btn whatsapp">&#xf232;</button>
          </div>
        </div>
      </div>

      <div class="product-details">
        <div style="border-bottom: 1px solid rgb(204, 204, 204);">
          <div class="wishlist">
            <i class="heart-icon" [class.active]="isWishlisted" (click)="toggleWishlist()"></i>
          </div>
          <h1 class="product-title">{{ product?.name }}</h1>
          <p class="fw-bold">Brand: <a [routerLink]="['/products-brand',product.sellerId]" routerLinkActive="router-link-active" >{{product.businessName}}</a></p>
        </div>

        <div class="pricing">
          <span class="current-price">EGP {{ getCurrentPrice() | number:'1.2-2' }}</span>
          <span *ngIf="hasDiscount()" class="original-price">
            EGP {{ selectedVariant.price }}
          </span>
        </div>
        <div class="stock-info text-warning fw-bold" [ngClass]="{ 'low-stock':lowStock }">
          {{ lowStock ? 'Some variations with low stock' : 'In Stock  :  '+ product.stockQuantity }}
        </div>
        <p>Free delivery to Al Salam City</p>

        <div class="rating-section">
          <div class="stars">
            <i *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= product.productId"></i>
          </div>
          <span class="rating-text">{{ "product.rating" }}</span>
        </div>
        <p *ngIf="product.variants && product.variants.length > 0">Our Options</p>
        <div class="variant-omages-thumbnail" *ngIf="product.variants && product.variants.length > 0">
          <div class="omages-thumbnail" *ngFor="let img of variantImages; let i = index"
            [class.active]="i === currentVariantImageIndex" (click)="currentVariantImageIndex = i">
            <img [src]="baseImageUrl + img" />
          </div>
        </div>
        <button class="add-to-cart-btn" (click)="openCartPopup()">Add to Cart</button>
      </div>
    </div>

    ---

    <div class="card">
      <div class="card-header" style="background-color:white !important;">
        Product details
      </div>
      <div class="card-body">
        <p class="card-text">{{product.description}}</p>
      </div>
    </div>

    ---

    <div class="modal-overlay" *ngIf="showCartPopup" (click)="closeCartPopup()">
      <div class="cart-popup" (click)="$event.stopPropagation()">
        <div class="popup-header">
          <h3>Select Quantities for Items</h3>
          <button class="close-btn" (click)="closeCartPopup()">×</button>
        </div>
        <div class="popup-content">
          <div *ngFor="let selection of cartSelections" class="variant-selection">
            <div class="variant-card">
              <img [src]="baseImageUrl + getItemImageUrl(selection.item)" class="variant-image">
              <div class="variant-info">
                <div class="variant-container">
                  <div>
                    <h4>{{ getItemName(selection.item) }}</h4>
                    <p class="variant-price">
                      EGP {{ (getItemPrice(selection.item) * (1 - getItemDiscountPercentage(selection.item) / 100)) |
                      number:'1.2-2' }}
                      <span *ngIf="getItemDiscountPercentage(selection.item) > 0" class="discount">
                        -{{ getItemDiscountPercentage(selection.item) }}%
                      </span>
                    </p>
                    <p class="variant-stock">
                      <ng-container *ngIf="getAvailableStockQuantity(selection.item) > 0">
                        {{ getAvailableStockQuantity(selection.item) }} available
                      </ng-container>
                      <ng-container *ngIf="getAvailableStockQuantity(selection.item) === 0"
                        [ngClass]="{'low-stock': true}">
                        Out of stock
                      </ng-container>
                    </p>
                  </div>

                  <div class="quantity-controls">
                    <button (click)="updateVariantQuantity(getItemIdentifier(selection.item), -1)"
                      [disabled]="selection.quantity <= 0 || getAvailableStockQuantity(selection.item) === 0">-</button>
                    <input  type="number" [(ngModel)]="selection.quantity"
                      (blur)="setVariantQuantity(getItemIdentifier(selection.item), selection.quantity)" [min]="0"
                      [max]="getAvailableStockQuantity(selection.item)"
                      [disabled]="getAvailableStockQuantity(selection.item) === 0"
                      disabled>
                    <button (click)="updateVariantQuantity(getItemIdentifier(selection.item), 1)"
                      [disabled]="selection.quantity >= getAvailableStockQuantity(selection.item) || getAvailableStockQuantity(selection.item) === 0">+</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="total-summary">
            Total Items: {{ getTotalItems() }} | Total Price: EGP {{ getTotalPrice() | number:'1.2-2' }}
          </div>
        </div>
        <div class="popup-actions">
          <button class="continue-shopping-btn" (click)="closeCartPopup()">Continue Shopping</button>
          <button class="add-to-cart-final-btn" (click)="addToCart()" [disabled]="getTotalItems() === 0">Add to
            Cart</button>
        </div>
      </div>
    </div>
  </div>

 <button class="ai-bot-toggle-btn" (click)="toggleChat()">
    <i class="fas fa-robot"></i> Product AI Bot
  </button>

  <div class="ai-bot-chat-container" [class.show-chat]="showChat">
    <div class="ai-bot-chat-header">
      <h4>Product AI Assistant</h4>
      <button class="ai-bot-close-btn" (click)="toggleChat()">×</button>
    </div>
    <div class="ai-bot-chat-messages">
      <div *ngFor="let message of messages" class="ai-bot-message-wrapper">
        <div class="ai-bot-message-bubble"
          [ngClass]="{'ai-bot-user-message': message.type === 'user', 'ai-bot-bot-message': message.type === 'bot'}">
          <div>
            <span>{{ message.text }}</span>
          </div>

          <div *ngIf="message.type === 'bot' && message.thought" class="thought-toggle-container">
            <span class="ai-bot-thought-label">Thinking</span>
            <span class="ai-bot-thought-arrow"
                  [class.rotated]="message.showThought"
                  (click)="toggleThought(message)">
              &#9660;
            </span>
            
          </div>
          
        </div>

        <div *ngIf="message.type === 'bot' && message.thought && message.showThought"
             class="ai-bot-thought-content">
          <p><strong>Bot's Thought Process:</strong></p>
          <p>{{ message.thought }}</p>
        </div>
      </div>

      <div *ngIf="isBotThinking" class="ai-bot-thinking-indicator">
        <span>Bot is thinking</span><span class="ai-bot-dot-1">.</span><span class="ai-bot-dot-2">.</span><span class="ai-bot-dot-3">.</span>
      </div>
    </div>
    <div class="ai-bot-chat-input">
      <input type="text" [(ngModel)]="currentQuestion" (keyup.enter)="sendMessage()"
        placeholder="Ask about this product...">
      <button (click)="sendMessage()" [disabled]="currentQuestion.trim() === ''">Send</button>
    </div>
  </div>
</div>

<ng-template #loading>
  <app-loading></app-loading>
</ng-template>
<app-product-reviews></app-product-reviews>

