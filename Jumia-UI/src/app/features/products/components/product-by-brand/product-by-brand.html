<div class="brand-header w-100 mb-4" *ngIf="sellerLoaded">
  <img [src]="baseImageUrl + bussinessLogo" [alt]="bussinessName" class="brand-image w-100">
</div>
<div class="products-row row p-5 m-5 mx-auto">
  <div *ngFor="let product of products" class="product-card mb-5 col-6 col-md-4 col-lg-3 col-xxl-2"
    (click)="goToProductDetails(product.productId)">
    <div class="product-image-wrapper">
      <img [src]="baseImageUrl + product.imageUrl" [alt]="product.name" class="product-image">
      <button class="wishlist-heart">♡</button>
    </div>

    <div class="product-details">
      <p class="product-title">{{ product.name }}</p>
      <div class="price-row">
        <span class="current-price">
          EGP {{ product.basePrice | discountPrice:product.discountPercentage | number:'1.2-2' }}
        </span>
        <div class="discount-old-price-container">
          <span *ngIf="(product.discountPercentage) as discount" class="old-price">
            EGP {{ product.basePrice | number:'1.2-2' }}
          </span>
          <span *ngIf="product.discountPercentage" class="discount-percent">
            -{{ product.discountPercentage }}%
          </span>
        </div>
      </div>
      <div class="brand-row"></div>
      <div class="add-to-cart">
        <button class="add-to-cart-btn" (click)="addToCart(product.productId,$event)">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

<!-- Pagination Controls -->
<div class="pagination" *ngIf="totalPages > 1">
  <button class="page-btn prev" (click)="prevPage()" [disabled]="currentPage === 1">‹</button>

  <button *ngFor="let page of getVisiblePages()"
          class="page-number"
          [class.active]="currentPage === page"
          (click)="goToPage(page)">
    {{ page }}
  </button>

  <button *ngIf="totalPages > 5 && currentPage < totalPages - 2" class="page-number disabled">...</button>

  <button *ngIf="totalPages > 5 && currentPage < totalPages - 1"
          class="page-number"
          [class.active]="currentPage === totalPages"
          (click)="goToPage(totalPages)">
    {{ totalPages }}
  </button>

  <button class="page-btn next" (click)="nextPage()" [disabled]="currentPage === totalPages">›</button>
</div>

<div class="modal-overlay" *ngIf="showCartPopup" (click)="closeCartPopup()">
  <div class="cart-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>Select Quantities</h3>
      <button class="close-btn" (click)="closeCartPopup()">×</button>
    </div>
    <div class="popup-content">
      <div *ngFor="let selection of cartSelections" class="variant-selection">
        <div class="variant-card">
          <img [src]="baseImageUrl + getItemImageUrl(selection.item)" class="variant-image">
          <div class="variant-info">
            <div class="variant-container">
              <div>
                <h4>{{ getItemName(selection.item) }}</h4>
                <p class="variant-price">
                  EGP {{ (getItemPrice(selection.item) * (1 - getItemDiscountPercentage(selection.item) / 100)) | number:'1.2-2' }}
                  <span *ngIf="getItemDiscountPercentage(selection.item) > 0" class="discount">
                    -{{ getItemDiscountPercentage(selection.item) }}%
                  </span>
                </p>
                <p class="variant-stock"></p>
                <p class="variant-stock" [ngClass]="{'low-stock': getItemStockQuantity(selection.item) < 5} ">
                  {{ getSelectionAvailableStock(selection) }} in stock
                </p>
              </div>

              <div class="quantity-controls">
                <button (click)="updateVariantQuantity(getItemIdentifier(selection.item), -1)"
                  [disabled]="selection.quantity <= 0 || getSelectionAvailableStock(selection) <= 0 || !getItemIsAvailable(selection.item)">-</button>
                <input type="number" [(ngModel)]="selection.quantity"
                  (blur)="setVariantQuantity(getItemIdentifier(selection.item), selection.quantity)"
                  [min]="0" [max]="getSelectionAvailableStock(selection)"
                  [disabled]="getSelectionAvailableStock(selection) <= 0 || !getItemIsAvailable(selection.item)">
                <button (click)="updateVariantQuantity(getItemIdentifier(selection.item), 1)"
                  [disabled]="selection.quantity >= getSelectionAvailableStock(selection) || getSelectionAvailableStock(selection) <= 0 || !getItemIsAvailable(selection.item)">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="cartSelections && cartSelections.length === 0" class="no-items-message">
          This product is currently out of stock or unavailable for adding to cart.
      </div>
      <div class="total-summary">
        Total Items: {{ getTotalItems() }} | Total Price: EGP {{ getTotalPrice() | number:'1.2-2' }}
      </div>
    </div>
    <div class="popup-actions">
      <button class="continue-shopping-btn" (click)="closeCartPopup()">Continue Shopping</button>
      <button class="add-to-cart-final-btn" (click)="addToCartApi()" [disabled]="getTotalItems() === 0">Add to Cart</button>
    </div>
  </div>
</div>
